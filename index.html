<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å‹•è»Šå®‰å…¨æ•‘æ´è¨“ç·´çµ±è¨ˆç³»çµ±</title>

    <!-- å·¥å…·åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        // ==========================================
        // âš ï¸ã€è«‹ä¿®æ”¹é€™è£¡ã€‘å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyq4OqLZSY9P0zHfzv7NWfmTmGmjj7Z-IIXecPMwQ6lymRbzilKnz6GxbOBLb2l0l-0/exec";
        // ==========================================
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        
        .sidebar-link { cursor: pointer; transition: all 0.2s; }
        .sidebar-link.active { background: rgba(37, 99, 235, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        .sidebar-link:hover:not(.active) { background: #1e293b; color: white; }
        
        /* â˜… è¡¨æ ¼å®¹å™¨ï¼šFlexbox è‡ªå‹•ä¼¸ç¸®ï¼Œç¢ºä¿æ²è»¸å‡ºç¾ä¸”ä¸å¡æ­» */
        .table-wrapper { 
            flex: 1;            
            min-height: 0;      /* é—œéµï¼šå…è¨±ç¸®å° */
            overflow: auto;     
            background: white; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
        }
        
        table { width: 100%; min-width: 1100px; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8fafc; color: #475569; font-weight: 700; padding: 10px; border: 1px solid #cbd5e1; font-size: 14px; position: sticky; top: 0; z-index: 10; }
        td { border: 1px solid #cbd5e1; height: 42px; padding: 0; vertical-align: middle; background: white; }
        
        input[type="text"], input[type="number"] { width: 100%; height: 100%; border: none; text-align: center; outline: none; font-size: 14px; background: transparent; color: #334155; }
        input:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }
        
        .example-row td { background: #f1f5f9; color: #94a3b8; font-style: italic; font-size: 13px; text-align: center; pointer-events: none; user-select: none; }
        
        .btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: 0.2s; font-size: 14px; }
        .btn-blue { background: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #059669; color: white; box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.3); }
        .btn-green:hover { background: #047857; }
        .btn-white { background: white; border: 1px solid #cbd5e1; color: #475569; }
        .btn-white:hover { background: #f8fafc; border-color: #94a3b8; color: #2563eb; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .day-cell { padding: 8px; text-align: center; border-radius: 6px; cursor: pointer; border: 1px solid #e2e8f0; font-size: 14px; background: white; }
        .day-cell:hover { background: #f1f5f9; }
        .day-cell.selected { background: #3b82f6; color: white; border-color: #2563eb; font-weight: bold; }
        .day-cell.weekend { color: #ef4444; }
        .day-cell.empty { border: none; background: transparent; cursor: default; }
        
        .gallery-card { break-inside: avoid; margin-bottom: 1.5rem; transition: transform 0.2s; }
        .gallery-card:hover { transform: translateY(-4px); }

        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden">
    <div id="loading">
        <div class="spinner mb-4"></div>
        <div class="font-bold text-lg" id="loadingText">è³‡æ–™è™•ç†ä¸­...</div>
    </div>

    <!-- å´é‚Šæ¬„ -->
    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-2xl z-20 shrink-0">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg"><i class="ri-charging-pile-2-line text-xl"></i></div>
            <div><h1 class="font-bold text-lg tracking-wide">é›»å‹•è»Šè¨“ç·´</h1><p class="text-xs text-slate-400">çµ±è¨ˆç®¡ç†ç³»çµ±</p></div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <div onclick="switchPage('input')" id="nav-input" class="sidebar-link active px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-edit-2-line text-xl"></i> æ–°å¢ä½œæ¥­å€</div>
            <div onclick="switchPage('history')" id="nav-history" class="sidebar-link px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-database-2-line text-xl"></i> æ­·å²è³‡æ–™åº«</div>
            <div onclick="switchPage('gallery')" id="nav-gallery" class="sidebar-link px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-gallery-view-2 text-xl text-yellow-400"></i> æˆæœå±•ç¤º</div>
        </nav>
    </aside>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative min-w-0">
        <div class="md:hidden h-14 bg-white border-b flex items-center px-4 justify-between shrink-0">
            <div class="font-bold text-slate-800">é›»å‹•è»Šè¨“ç·´çµ±è¨ˆ</div>
            <div class="flex gap-4">
                <button onclick="switchPage('input')" class="text-blue-600"><i class="ri-edit-2-line"></i></button>
                <button onclick="switchPage('history')" class="text-slate-500"><i class="ri-database-2-line"></i></button>
            </div>
        </div>

        <!-- é é¢ A: æ–°å¢ä½œæ¥­å€ -->
        <div id="page-input" class="flex-1 flex flex-col p-6 overflow-hidden h-full">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-6 bg-blue-600 rounded-full"></span>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">æ–°å¢ä½œæ¥­å€</h2>
                        <p class="text-xs text-rose-600 font-bold mt-0.5">â€» æ³¨æ„ï¼šåƒèˆ‡äººæ•¸è«‹å¡«å¯«ã€Œè©²æ¬¡è¨“ç·´æ‰€æœ‰æ¢¯æ¬¡çš„ç¸½å’Œã€ã€‚</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-white" onclick="downloadTemplate()"><i class="ri-file-download-line"></i> ä¸‹è¼‰ç¯„æœ¬</button>
                    <button class="btn btn-white" onclick="$('#csvInput').click()"><i class="ri-upload-2-line"></i> åŒ¯å…¥ CSV</button>
                    <button class="btn btn-blue" onclick="saveToCloud()"><i class="ri-cloud-upload-line"></i> å„²å­˜è‡³é›²ç«¯</button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table id="inputTable">
                    <thead>
                        <tr>
                            <th style="width:50px">åˆªé™¤</th>
                            <th style="width:50px">é …æ¬¡</th>
                            <th style="width:220px">æ—¥æœŸ</th>
                            <th style="width:150px">å–®ä½/å±¤ç´š</th>
                            <th style="width:200px">åœ°é»</th>
                            <th style="width:200px">è¨“ç·´é …ç›®</th>
                            <th style="width:80px">è¾¦ç†<br>å ´æ¬¡</th>
                            <th style="width:80px">åƒèˆ‡<br>äººæ•¸</th>
                            <th style="width:150px">å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody id="inputBody"></tbody>
                    <tfoot class="example-row"><tr><td></td><td>Ex</td><td>114å¹´1æœˆ1ã€2æ—¥</td><td>ä¿¡ç¾©ä¸­éšŠ</td><td>åœ°ä¸‹åœè»Šå ´</td><td>æ»…ç«æ¯¯æ“ä½œ</td><td>1</td><td>20</td><td>(ç¯„ä¾‹)</td></tr></tfoot>
                </table>
            </div>
            
            <div class="mt-4 flex justify-center shrink-0">
                <button class="btn btn-white w-full md:w-auto justify-center shadow-sm" onclick="addInputRow()"><i class="ri-add-line text-lg"></i> æ–°å¢ä¸€åˆ—</button>
            </div>
        </div>

        <!-- é é¢ B: æ­·å²è³‡æ–™åº« -->
        <div id="page-history" class="hidden flex-col p-6 overflow-hidden h-full">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-6 bg-emerald-600 rounded-full"></span>
                    <h2 class="text-xl font-bold text-slate-800">æ­·å²è³‡æ–™åº«</h2>
                    <span class="text-sm text-slate-500 ml-2">(åŒ…å«æ‰€æœ‰å·²å­˜æª”è³‡æ–™)</span>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-white" onclick="loadHistory()">
                        <i class="ri-refresh-line"></i> é‡æ–°æ•´ç†
                    </button>
                    <div class="relative group">
                        <button class="btn btn-green">
                            <i class="ri-file-excel-2-line"></i> ä¸‹è¼‰å ±è¡¨
                        </button>
                        <div class="absolute right-0 top-full pt-2 w-56 hidden group-hover:block z-50">
                            <div class="bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden p-1">
                                <div onclick="exportExcel('report')" class="px-4 py-3 hover:bg-emerald-50 rounded-lg cursor-pointer text-sm font-bold text-emerald-700 mb-1 flex items-center transition">
                                    <i class="ri-file-list-3-line mr-2 text-lg"></i>é™³å ±ä¸Šç´šç‰ˆ (ç²¾ç°¡)
                                </div>
                                <div onclick="exportExcel('full')" class="px-4 py-3 hover:bg-slate-50 rounded-lg cursor-pointer text-sm text-slate-600 flex items-center transition">
                                    <i class="ri-database-2-line mr-2 text-lg"></i>å®Œæ•´è³‡æ–™åº« (å‚™ä»½)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-emerald-50 border border-emerald-100 px-4 py-3 rounded-xl mb-4 flex gap-6 text-sm text-emerald-800 font-bold shadow-sm shrink-0">
                <div><i class="ri-bar-chart-box-line text-lg mr-1"></i> ç¸½å ´æ¬¡ï¼š<span id="histTotalSession" class="text-xl">0</span> å ´</div>
                <div><i class="ri-group-line text-lg mr-1"></i> ç¸½äººæ•¸ï¼š<span id="histTotalPeople" class="text-xl">0</span> äºº</div>
            </div>

            <!-- â˜… è¡¨æ ¼å®¹å™¨ï¼šç¢ºä¿æœ‰ min-height:0 ä»¥æ”¯æ´æ²å‹• -->
            <div class="table-wrapper flex-1 min-h-0 overflow-auto bg-white border border-slate-200 rounded-lg shadow-sm mb-0">
                <table id="historyTable">
                    <thead><tr><th style="width:60px">é …æ¬¡</th><th style="width:220px">æ—¥æœŸ</th><th style="width:120px">å–®ä½/å±¤ç´š</th><th style="width:150px">åœ°é»</th><th style="width:200px">è¨“ç·´é …ç›®</th><th style="width:60px">å ´æ¬¡</th><th style="width:60px">äººæ•¸</th><th style="width:120px">å‚™è¨»</th><th style="width:100px">æˆæœç…§ç‰‡</th></tr></thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>

            <!-- åˆ†é åˆ— -->
            <div class="h-[60px] flex items-center justify-between border-t border-slate-200 pt-3 mt-2 shrink-0 bg-slate-100">
                <div class="text-sm text-slate-500">é¡¯ç¤ºç¬¬ <span id="pageInfoStart" class="font-bold text-slate-700">0</span> - <span id="pageInfoEnd" class="font-bold text-slate-700">0</span> ç­†ï¼Œå…± <span id="pageInfoTotal" class="font-bold text-slate-700">0</span> ç­†</div>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" id="prevBtn" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition"><i class="ri-arrow-left-s-line"></i> ä¸Šä¸€é </button>
                    <button onclick="changePage(1)" id="nextBtn" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition">ä¸‹ä¸€é  <i class="ri-arrow-right-s-line"></i></button>
                </div>
            </div>
        </div>

        <!-- é é¢ C: æˆæœå±•ç¤º -->
        <div id="page-gallery" class="hidden flex-1 flex-col p-6 overflow-hidden h-full bg-slate-50">
            <div class="flex justify-between items-center mb-6 shrink-0">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-6 bg-yellow-400 rounded-full"></span>
                    <h2 class="text-xl font-bold text-slate-800">æˆæœå±•ç¤ºç‰†</h2>
                </div>
                <div class="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                    <button id="btnGalleryLatest" class="px-4 py-1.5 rounded-lg text-sm font-bold transition text-slate-500 hover:text-slate-800" onclick="renderGallery('latest')">ğŸ”¥ æœ€æ–°</button>
                    <button id="btnGalleryRandom" class="px-4 py-1.5 rounded-lg text-sm font-bold transition bg-slate-800 text-white shadow" onclick="renderGallery('random')">ğŸ² éš¨æ©Ÿ</button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto min-h-0 pr-2" id="galleryContainer">
                <div class="columns-1 md:columns-2 lg:columns-3 xl:columns-4 gap-6 space-y-6" id="galleryGrid"></div>
            </div>
        </div>
    </main>

    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">
    <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handlePhotoUpload(this)">

    <!-- æ—¥æ›† Modal -->
    <div id="calendarModal" class="fixed inset-0 bg-black/50 hidden z-[1000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[350px] p-5 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-2">
                <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-100 rounded"><i class="ri-arrow-left-s-line"></i></button>
                <div class="font-bold text-lg" id="calMonthTitle">2025å¹´ 1æœˆ</div>
                <button onclick="changeMonth(1)" class="p-1 hover:bg-slate-100 rounded"><i class="ri-arrow-right-s-line"></i></button>
            </div>
            <div class="flex gap-2 mb-3 text-xs">
                <button onclick="calFilter('all')" class="flex-1 py-1 border rounded hover:bg-slate-50">å…¨é¸</button>
                <button onclick="calFilter('noWeekend')" class="flex-1 py-1 border rounded hover:bg-slate-50">æ’é™¤å…­æ—¥</button>
                <button onclick="calFilter('onlyWeekend')" class="flex-1 py-1 border rounded hover:bg-slate-50">åƒ…é¸å…­æ—¥</button>
                <button onclick="calClear()" class="px-2 py-1 border border-red-200 text-red-500 rounded hover:bg-red-50">æ¸…</button>
            </div>
            <div class="calendar-grid text-sm font-bold text-slate-400 mb-1"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
            <div id="calGrid" class="calendar-grid"></div>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="$('#calendarModal').classList.add('hidden')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="confirmDate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        const $ = (s) => document.querySelector(s);
        let inputData = [], historyData = [], currentCalRow = null, selectedDates = new Set(), currentYear = 2025, currentMonth = 1;
        let currentPage = 1;
        const itemsPerPage = 20;
        let uploadTarget = null; 
        let galleryMode = 'random'; 

        window.onload = function() { 
            addInputRow(); 
            loadHistory(); 
        };

        function switchPage(page) {
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            if(document.getElementById(`nav-${page}`)) document.getElementById(`nav-${page}`).classList.add('active');
            
            $('#page-input').classList.add('hidden'); 
            $('#page-history').classList.add('hidden'); 
            $('#page-history').classList.remove('flex');
            $('#page-gallery').classList.add('hidden'); 
            $('#page-gallery').classList.remove('flex');
            
            const target = $(`#page-${page}`);
            target.classList.remove('hidden');
            
            if(page === 'history' || page === 'gallery') target.classList.add('flex');
            if(page === 'gallery') renderGallery(galleryMode);
        }

        function fixYearFormat(str) { if(!str) return ""; return str.replace(/^0+(11\d)/, '$1'); }

        function addInputRow(data={}) {
            inputData.push({ date: data.date||'', unit: data.unit||'', loc: data.loc||'', item: data.item||'', session: data.session||'', people: data.people||'', note: data.note||'' });
            renderInputTable();
        }
        function removeInputRow(idx) {
            if (inputData.length > 1) inputData.splice(idx, 1); else inputData[0] = {date:'', unit:'', loc:'', item:'', session:'', people:'', note:''};
            renderInputTable();
        }
        function renderInputTable() {
            const tbody = $('#inputBody'); tbody.innerHTML = '';
            inputData.forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-center"><button onclick="removeInputRow(${i})" class="text-slate-300 hover:text-red-500"><i class="ri-close-circle-fill text-xl"></i></button></td><td class="text-center text-slate-400 font-mono">${i + 1}</td><td><div class="flex items-center h-full"><input type="text" value="${row.date}" onchange="inputData[${i}].date=this.value" placeholder="é»æ“Šé¸å–æ—¥æœŸ"><button onclick="openCalendar(${i})" class="w-8 h-full bg-slate-50 border-l hover:text-blue-600"><i class="ri-calendar-line"></i></button></div></td><td><input type="text" value="${row.unit}" onchange="inputData[${i}].unit=this.value"></td><td><input type="text" value="${row.loc}" onchange="inputData[${i}].loc=this.value"></td><td><input type="text" value="${row.item}" onchange="inputData[${i}].item=this.value"></td><td><input type="number" value="${row.session}" onchange="inputData[${i}].session=this.value"></td><td><input type="number" value="${row.people}" onchange="inputData[${i}].people=this.value"></td><td><input type="text" value="${row.note}" onchange="inputData[${i}].note=this.value"></td>`;
                tbody.appendChild(tr);
            });
        }

        function showLoading(msg) { $('#loadingText').innerText = msg; $('#loading').style.display = 'flex'; }
        function hideLoading() { $('#loading').style.display = 'none'; }

        function saveToCloud() {
            const validData = inputData.filter(r => r.date || r.item || r.session);
            if (validData.length === 0) return alert('æ²’æœ‰è³‡æ–™å¯å„²å­˜');
            validData.forEach(r => r.date = fixYearFormat(r.date));
            showLoading("è³‡æ–™å„²å­˜ä¸­...");
            fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ data: validData, mode: 'append' }), headers: { 'Content-Type': 'text/plain' } })
            .then(res => res.json())
            .then(json => {
                if (json.status === 'success') { alert('å„²å­˜æˆåŠŸï¼'); inputData=[]; addInputRow(); loadHistory(); } else alert('å„²å­˜å¤±æ•—: ' + json.message);
            }).catch((err)=>{ console.error(err); alert('é€£ç·šéŒ¯èª¤'); }).finally(() => hideLoading());
        }

        function downloadTemplate() {
            const csv = "\uFEFFæ—¥æœŸ,å–®ä½/å±¤ç´š,åœ°é»,è¨“ç·´é …ç›®,è¾¦ç†å ´æ¬¡,åƒèˆ‡äººæ•¸,å‚™è¨»\n114å¹´1æœˆ1æ—¥,ä¿¡ç¾©ä¸­éšŠ,é§åœ°,æ»…ç«æ¯¯æ“ä½œ,1,15,ç¯„ä¾‹";
            saveAs(new Blob([csv], { type: 'text/csv;charset=utf-8;' }), "è¨“ç·´çµ±è¨ˆåŒ¯å…¥ç¯„æœ¬.csv");
        }

        function processCSV(input) {
            if (!input.files[0]) return;
            Papa.parse(input.files[0], { header: true, skipEmptyLines: true, complete: function (res) {
                const imp = res.data; let count = 0;
                imp.forEach(r => {
                    const rowStr = JSON.stringify(r); if (rowStr.includes("ç¸½è¨ˆ") || rowStr.includes("åˆè¨ˆ") || rowStr.includes("ç¯„ä¾‹")) return; 
                    const get = (keys) => { for(let k of Object.keys(r)) if(keys.some(key=>k.includes(key))) return r[k]; return ''; };
                    let cleanDate = fixYearFormat(get(['æ—¥æœŸ','Date']));
                    inputData.push({ date: cleanDate, unit: get(['å–®ä½','Unit']), loc: get(['åœ°é»','Loc']), item: get(['é …ç›®','Item']), session: get(['å ´æ¬¡','Session']), people: get(['äººæ•¸','Peo']), note: get(['å‚™è¨»']) });
                    count++;
                });
                renderInputTable(); alert(`å·²åŒ¯å…¥ ${count} ç­†è³‡æ–™`); input.value = '';
            }});
        }

        function getDateValue(dateStr) {
            if (!dateStr) return 0;
            const cleanStr = fixYearFormat(dateStr);
            const m = cleanStr.match(/(\d+)å¹´(\d+)æœˆ(\d+)/);
            if (m) { let y = parseInt(m[1]); let month = parseInt(m[2]); let day = parseInt(m[3]); return y * 10000 + month * 100 + day; }
            return 0;
        }

        function loadHistory() {
            if(GAS_API_URL.includes("è«‹å¡«å…¥")) return;
            showLoading("è³‡æ–™è®€å–ä¸­...");
            fetch(GAS_API_URL).then(r => r.json()).then(json => {
                if (json.status === 'success') {
                    historyData = json.data;
                    historyData.forEach(r => r.date = fixYearFormat(r.date));
                    historyData.sort((a, b) => getDateValue(b.date) - getDateValue(a.date));
                    currentPage = 1;
                    renderHistoryTable();
                }
            }).catch(err => console.error("è¼‰å…¥å¤±æ•—", err)).finally(() => hideLoading());
        }

        function changePage(delta) {
            const maxPage = Math.ceil(historyData.length / itemsPerPage);
            currentPage += delta;
            if(currentPage < 1) currentPage = 1;
            if(currentPage > maxPage) currentPage = maxPage;
            renderHistoryTable();
        }

        function renderHistoryTable() {
            const tbody = $('#historyBody'); tbody.innerHTML = '';
            let tSession = 0, tPeople = 0;
            historyData.forEach(row => { tSession += parseInt(row.session)||0; tPeople += parseInt(row.people)||0; });
            $('#histTotalSession').innerText = tSession; $('#histTotalPeople').innerText = tPeople;

            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageData = historyData.slice(startIdx, endIdx);

            pageData.forEach((row, i) => {
                const globalIndex = startIdx + i + 1;
                const tr = document.createElement('tr');
                tr.className = i % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                
                let photoBtn = '';
                if(row.folderUrl) {
                    photoBtn = `
                    <div class="flex gap-2 justify-center items-center">
                        <a href="${row.folderUrl}" target="_blank" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-emerald-700 shadow-sm" title="é–‹å•Ÿè³‡æ–™å¤¾">
                            <i class="ri-folder-open-fill"></i> å·²å»ºæª”
                        </a>
                        <button onclick="triggerPhotoUpload(${startIdx + i})" class="text-slate-300 hover:text-blue-500" title="åŠ å‚³ç…§ç‰‡"><i class="ri-add-circle-fill text-lg"></i></button>
                    </div>`;
                } else {
                    photoBtn = `<button onclick="triggerPhotoUpload(${startIdx + i})" class="text-slate-400 hover:text-blue-600 transition bg-slate-50 px-3 py-1 rounded border border-slate-200 text-xs flex items-center gap-1 mx-auto"><i class="ri-camera-line"></i> ä¸Šå‚³</button>`;
                }

                tr.innerHTML = `<td class="text-center text-slate-500 font-mono text-xs">${globalIndex}</td><td class="px-2">${row.date}</td><td class="px-2 text-slate-600 text-sm">${row.unit}</td><td class="px-2 text-slate-600 text-sm">${row.loc}</td><td class="px-2">${row.item}</td><td class="text-center font-bold text-blue-600">${row.session}</td><td class="text-center font-bold text-emerald-600">${row.people}</td><td class="px-2 text-xs text-slate-400">${row.note}</td><td class="text-center">${photoBtn}</td>`;
                tbody.appendChild(tr);
            });

            $('#pageInfoStart').innerText = historyData.length > 0 ? startIdx + 1 : 0;
            $('#pageInfoEnd').innerText = Math.min(endIdx, historyData.length);
            $('#pageInfoTotal').innerText = historyData.length;
            $('#prevBtn').disabled = currentPage === 1;
            $('#nextBtn').disabled = endIdx >= historyData.length;
        }

        function triggerPhotoUpload(index) {
            uploadTarget = historyData[index];
            $('#photoInput').click();
        }

        // â˜… é—œéµä¿®æ”¹ï¼šåŠ å…¥éŒ¯èª¤å›å ±èˆ‡é‡æ–°æ•´ç†é‚è¼¯
        async function handlePhotoUpload(input) {
            if (!input.files || input.files.length === 0) return;
            if (!uploadTarget) return alert("ç³»çµ±éŒ¯èª¤");

            showLoading(`æ­£åœ¨ä¸Šå‚³ ${input.files.length} å¼µç…§ç‰‡...`);
            
            let successCount = 0;
            let failMsg = "";

            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                try {
                    const base64 = await fileToBase64(file);
                    const payload = {
                        mode: 'upload_image',
                        data: {
                            date: uploadTarget.date,
                            unit: uploadTarget.unit,
                            item: uploadTarget.item,
                            fileData: base64.split(',')[1],
                            mimeType: file.type,
                            fileName: file.name
                        }
                    };

                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'text/plain' }
                    });
                    
                    const json = await res.json();
                    if (json.status === 'success') {
                        successCount++;
                    } else {
                        console.error("å¾Œç«¯éŒ¯èª¤:", json);
                        failMsg = json.message;
                    }

                } catch (e) {
                    console.error(e);
                    failMsg = "ç¶²è·¯é€£ç·šéŒ¯èª¤";
                }
            }

            hideLoading();
            input.value = ''; 

            if (successCount > 0) {
                alert(`æˆåŠŸä¸Šå‚³ ${successCount} å¼µç…§ç‰‡ï¼\né‡æ–°è¼‰å…¥è³‡æ–™åº«...`);
                loadHistory(); 
            } else {
                alert(`ä¸Šå‚³å¤±æ•—ï¼\nåŸå› ï¼š${failMsg}\n\n(è«‹æª¢æŸ¥è³‡æ–™åº«ä¸­çš„æ–‡å­—èˆ‡ç¶²é é¡¯ç¤ºæ˜¯å¦å®Œå…¨ä¸€è‡´)`);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function renderGallery(mode = 'random') {
            galleryMode = mode; 
            
            const btnLatest = $('#btnGalleryLatest');
            const btnRandom = $('#btnGalleryRandom');
            if (mode === 'latest') {
                btnLatest.className = "px-4 py-1.5 rounded-lg text-sm font-bold transition bg-slate-800 text-white shadow";
                btnRandom.className = "px-4 py-1.5 rounded-lg text-sm font-bold transition text-slate-500 hover:text-slate-800";
            } else {
                btnRandom.className = "px-4 py-1.5 rounded-lg text-sm font-bold transition bg-slate-800 text-white shadow";
                btnLatest.className = "px-4 py-1.5 rounded-lg text-sm font-bold transition text-slate-500 hover:text-slate-800";
            }

            const container = $('#galleryGrid');
            container.innerHTML = '';

            let withPhotos = historyData.filter(r => r.coverUrl);
            let withoutPhotos = historyData.filter(r => !r.coverUrl);
            let displayList = [];

            if (mode === 'latest') {
                displayList = [...withPhotos, ...withoutPhotos].slice(0, 24);
            } else {
                withPhotos.sort(() => Math.random() - 0.5);
                withoutPhotos.sort(() => Math.random() - 0.5);
                displayList = [...withPhotos, ...withoutPhotos].slice(0, 24);
            }

            displayList.forEach(item => {
                let cardContent = '';
                if (item.coverUrl) {
                    cardContent = `
                        <img src="${item.coverUrl}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" loading="lazy">
                        ${item.folderUrl ? '<div class="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded-lg backdrop-blur-sm"><i class="ri-image-2-line"></i> ç›¸ç°¿</div>' : ''}
                    `;
                } else {
                    // â˜… æ²’ç…§ç‰‡é¡¯ç¤ºè³‡æ–™å»ºæ§‹ä¸­
                    cardContent = `
                        <div class="w-full h-full bg-slate-100 flex flex-col items-center justify-center text-slate-400">
                            <i class="ri-folder-unknow-line text-3xl mb-1"></i>
                            <span class="text-xs font-bold tracking-widest">è³‡æ–™å»ºæ§‹ä¸­</span>
                        </div>
                    `;
                }

                const card = document.createElement('div');
                card.className = 'gallery-card bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-100 cursor-pointer group';
                card.onclick = () => { if(item.folderUrl) window.open(item.folderUrl, '_blank'); };
                
                card.innerHTML = `
                    <div class="relative overflow-hidden aspect-video bg-slate-50">
                        ${cardContent}
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-slate-800 line-clamp-1 mb-1">${item.item}</h3>
                        <div class="flex justify-between items-center text-xs text-slate-500">
                            <span><i class="ri-calendar-line"></i> ${item.date}</span>
                            <span class="bg-slate-100 px-2 py-0.5 rounded-full">${item.unit}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openCalendar(idx) { currentCalRow = idx; selectedDates.clear(); renderCalendarGrid(); $('#calendarModal').classList.remove('hidden'); $('#calendarModal').classList.add('flex'); }
        function renderCalendarGrid() {
            const grid = $('#calGrid'); grid.innerHTML = '';
            $('#calMonthTitle').innerText = `${currentYear}å¹´ ${currentMonth}æœˆ`;
            const days = new Date(currentYear, currentMonth, 0).getDate();
            const first = new Date(currentYear, currentMonth - 1, 1).getDay();
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="day-cell empty"></div>`;
            for(let d=1; d<=days; d++) {
                const key = `${currentYear}/${currentMonth}/${d}`; const w = new Date(currentYear, currentMonth-1, d).getDay(); const isWk = (w===0||w===6);
                const isSel = selectedDates.has(key);
                const div = document.createElement('div');
                div.className = `day-cell ${isWk?'weekend':''} ${isSel?'selected':''}`; div.innerText = d;
                div.onclick = () => { if(selectedDates.has(key)) selectedDates.delete(key); else selectedDates.add(key); renderCalendarGrid(); };
                grid.appendChild(div);
            }
        }
        function changeMonth(delta) { currentMonth+=delta; if(currentMonth>12){currentMonth=1;currentYear++;} if(currentMonth<1){currentMonth=12;currentYear--;} renderCalendarGrid(); }
        function calFilter(type) {
            const days = new Date(currentYear, currentMonth, 0).getDate();
            for(let d=1; d<=days; d++) {
                const key = `${currentYear}/${currentMonth}/${d}`; const w = new Date(currentYear, currentMonth-1, d).getDay(); const isWk = (w===0||w===6);
                if (type==='all') selectedDates.add(key);
                else if (type==='noWeekend' && !isWk) selectedDates.add(key);
                else if (type==='onlyWeekend' && isWk) selectedDates.add(key);
            } renderCalendarGrid();
        }
        function calClear() { selectedDates.clear(); renderCalendarGrid(); }
        function confirmDate() {
            const sorted = Array.from(selectedDates).map(s=>{const[y,m,d]=s.split('/').map(Number); return {y,m,d}}).sort((a,b)=>(a.y*10000+a.m*100+a.d)-(b.y*10000+b.m*100+b.d));
            if(sorted.length===0) { $('#calendarModal').classList.add('hidden'); return; }
            let groups = {}; sorted.forEach(o=>{ const k=`${o.y}-${o.m}`; if(!groups[k]) groups[k]=[]; groups[k].push(o.d); });
            let parts = []; for(let k in groups) { const [y,m]=k.split('-').map(Number); parts.push(`${y-1911}å¹´${m}æœˆ${groups[k].join('ã€')}æ—¥`); }
            inputData[currentCalRow].date = parts.join('ï¼›'); renderInputTable(); $('#calendarModal').classList.add('hidden');
        }

        async function exportExcel(mode) {
            const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('çµ±è¨ˆè¡¨');
            const isFull = mode === 'full';
            ws.columns = isFull ? [{header:'é …æ¬¡',key:'id',width:8},{header:'æ—¥æœŸ',key:'date',width:30},{header:'å–®ä½',key:'unit',width:20},{header:'åœ°é»',key:'loc',width:25},{header:'è¨“ç·´é …ç›®',key:'item',width:40},{header:'å ´æ¬¡',key:'session',width:12},{header:'äººæ•¸',key:'people',width:12},{header:'å‚™è¨»',key:'note',width:20}] : [{header:'é …æ¬¡',key:'id',width:8},{header:'æ—¥æœŸ',key:'date',width:35},{header:'è¨“ç·´é …ç›®',key:'item',width:45},{header:'è¾¦ç†å ´æ¬¡',key:'session',width:15},{header:'åƒèˆ‡äººæ•¸',key:'people',width:15}];
            ws.getRow(1).eachCell(c=>{c.font={bold:true,color:{argb:'FFFFFFFF'}};c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF1F2937'}};});
            historyData.forEach((r,i)=>{ ws.addRow({...r, id:i+1}); });
            ws.addRow({item:'ç¸½è¨ˆ', session:$('#histTotalSession').innerText, people:$('#histTotalPeople').innerText}).eachCell(c=>{c.font={bold:true,color:{argb:'FFB91C1C'}};});
            const buf = await wb.xlsx.writeBuffer(); saveAs(new Blob([buf]), 'è¨“ç·´çµ±è¨ˆ.xlsx');
        }
    </script>
</body>
</html>
