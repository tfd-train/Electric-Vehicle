<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å‹•è»Šå®‰å…¨æ•‘æ´è¨“ç·´çµ±è¨ˆç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        // ==========================================
        // âš ï¸ã€è«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€ã€‘
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzqBglqQq0srj4Wne5HsdMK1w0IbaT3DdhXPsjKUsSjkEOohGZslBVXnRyuGIZGp1YJ/exec"; 
        
        // ğŸ”— ç³»çµ±é€£çµ
        const SYSTEM_LINKS = {
            portal: "https://tfd-train.github.io/Training-Management-Platform/",
            flow: "https://tfd-train.github.io/Training-Flow-Management/",
            booking: "https://tfd-train.github.io/Facility-Booking/"
        };
        // ==========================================

        const AUDIT_UNITS = {
            "ç¬¬ä¸€å¤§éšŠ": {
                "æœ¬éƒ¨": ["ç¬¬ä¸€æ•‘ç½æ•‘è­·å¤§éšŠ"],
                "ä¸­æ­£ä¸­éšŠ": ["ä¸­æ­£ä¸­éšŠ", "è¯å±±åˆ†éšŠ", "æ³‰å·åˆ†éšŠ", "å¤äº­åˆ†éšŠ", "åŸä¸­åˆ†éšŠ"], 
                "è¬è¯ä¸­éšŠ": ["è¬è¯ä¸­éšŠ", "é›™åœ’åˆ†éšŠ", "é¾å±±åˆ†éšŠ"],
                "æ–‡å±±ä¸­éšŠ": ["æ–‡å±±ä¸­éšŠ", "è¬èŠ³åˆ†éšŠ", "æ™¯ç¾åˆ†éšŠ", "æœ¨æŸµåˆ†éšŠ", "å¯¶æ©‹åˆ†éšŠ"]
            },
            "ç¬¬äºŒå¤§éšŠ": {
                "æœ¬éƒ¨": ["ç¬¬äºŒæ•‘ç½æ•‘è­·å¤§éšŠ"],
                "å¤§å®‰ä¸­éšŠ": ["å¤§å®‰ä¸­éšŠ", "é‡‘è¯åˆ†éšŠ", "å¾©èˆˆåˆ†éšŠ", "å®‰å’Œåˆ†éšŠ"],
                "ä¿¡ç¾©ä¸­éšŠ": ["ä¿¡ç¾©ä¸­éšŠ", "ä¿¡ç¾©åˆ†éšŠ", "èŠæ•¬åˆ†éšŠ"], 
                "å—æ¸¯ä¸­éšŠ": ["å—æ¸¯ä¸­éšŠ", "å—æ¸¯åˆ†éšŠ", "èˆŠèŠåˆ†éšŠ", "æˆå¾·åˆ†éšŠ"]
            },
            "ç¬¬ä¸‰å¤§éšŠ": {
                "æœ¬éƒ¨": ["ç¬¬ä¸‰æ•‘ç½æ•‘è­·å¤§éšŠ"],
                "ä¸­å±±ä¸­éšŠ": ["ä¸­å±±ä¸­éšŠ", "å¤§ç›´åˆ†éšŠ", "åœ“å±±åˆ†éšŠ", "æ¾æ±Ÿåˆ†éšŠ"], 
                "æ¾å±±ä¸­éšŠ": ["æ¾å±±ä¸­éšŠ", "ä¸­å´™åˆ†éšŠ", "å…«å¾·åˆ†éšŠ"],
                "å…§æ¹–ä¸­éšŠ": ["å…§æ¹–ä¸­éšŠ", "æ°‘æ¬Šåˆ†éšŠ", "å…§æ¹–åˆ†éšŠ", "å¤§æ¹–åˆ†éšŠ", "æ±æ¹–åˆ†éšŠ"]
            },
            "ç¬¬å››å¤§éšŠ": {
                "æœ¬éƒ¨": ["ç¬¬å››æ•‘ç½æ•‘è­·å¤§éšŠ"],
                "å¤§åŒä¸­éšŠ": ["å¤§åŒä¸­éšŠ", "å»ºæˆåˆ†éšŠ", "å»¶å¹³åˆ†éšŠ", "å¤§åŒåˆ†éšŠ"],
                "å£«æ—ä¸­éšŠ": ["å£«æ—ä¸­éšŠ", "å±±ä»”ååˆ†éšŠ", "å¤©æ¯åˆ†éšŠ", "ç¦å®‰åˆ†éšŠ", "ç¤¾å­åˆ†éšŠ", "åŠæ½­åˆ†éšŠ", "é›™æºªåˆ†éšŠ"], 
                "åŒ—æŠ•ä¸­éšŠ": ["åŒ—æŠ•ä¸­éšŠ", "é™½æ˜å±±åˆ†éšŠ", "å…‰æ˜åˆ†éšŠ", "é—œæ¸¡åˆ†éšŠ", "çŸ³ç‰Œåˆ†éšŠ", "ç§€å±±åˆ†éšŠ"]
            }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        
        aside { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }
        @media (min-width: 768px) { .sidebar-closed { transform: translateX(0); } }

        .sidebar-link { cursor: pointer; transition: all 0.2s; }
        .sidebar-link.active { background: rgba(37, 99, 235, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        .sidebar-link:hover:not(.active) { background: #1e293b; color: white; }
        
        .table-wrapper { width: 100%; overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; min-width: 1100px; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8fafc; color: #475569; font-weight: 700; padding: 10px; border: 1px solid #cbd5e1; font-size: 14px; position: sticky; top: 0; z-index: 10; }
        
        td { border: 1px solid #cbd5e1; height: auto; padding: 6px 4px; vertical-align: top; background: white; }
        input { width: 100%; height: 28px; border: none; text-align: center; outline: none; background: transparent; font-weight: 500; color: #1e293b; font-size: 14px; }
        input:focus { background: #eff6ff; border-radius: 4px; }
        
        .example-row td { background: #f1f5f9; color: #94a3b8; font-style: italic; pointer-events: none; padding: 12px 4px; vertical-align: middle; }
        
        .btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: 0.2s; font-size: 14px; }
        .btn-blue { background: #2563eb; color: white; } .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #059669; color: white; } .btn-green:hover { background: #047857; }
        .btn-white { background: white; border: 1px solid #cbd5e1; color: #475569; } .btn-white:hover { background: #f8fafc; border-color: #94a3b8; color: #2563eb; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .day-cell { padding: 8px; text-align: center; border-radius: 6px; cursor: pointer; border: 1px solid #e2e8f0; font-size: 14px; background: white; }
        .day-cell.selected { background: #3b82f6; color: white; font-weight: bold; }
        .day-cell.weekend { color: #ef4444; }
        
        .gallery-card { transition: transform 0.2s; display: flex; flex-direction: column; }
        .gallery-card:hover { transform: translateY(-4px); }
        
        #alertBanner { transition: all 0.5s ease-in-out; }
        #alertBanner.hidden { display: none; }

        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 h-screen flex overflow-hidden">
    <div id="loading"><div class="spinner mb-4"></div><div class="font-bold text-lg" id="loadingText">è³‡æ–™è™•ç†ä¸­...</div></div>

    <aside id="mainSidebar" class="w-64 bg-slate-900 text-white flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out shadow-2xl md:flex shrink-0">
        <div class="p-6 border-b border-slate-800 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg"><i class="ri-charging-pile-2-line text-xl"></i></div>
                <div><h1 class="font-bold text-lg tracking-wide">é›»å‹•è»Šè¨“ç·´</h1><p class="text-xs text-slate-400">çµ±è¨ˆç®¡ç†ç³»çµ±</p></div>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i class="ri-close-line text-2xl"></i></button>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div onclick="switchPage('input')" id="nav-input" class="sidebar-link active px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-edit-2-line text-xl"></i> æ–°å¢ä½œæ¥­å€</div>
            <div onclick="switchPage('history')" id="nav-history" class="sidebar-link px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-database-2-line text-xl"></i> æ­·å²è³‡æ–™åº«</div>
            <div onclick="switchPage('gallery')" id="nav-gallery" class="sidebar-link px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-gallery-view-2 text-xl text-yellow-400"></i> æˆæœå±•ç¤º</div>
        
            <div class="pt-8 pb-2">
                <div class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">ç³»çµ±å¿«é€Ÿé€£çµ</div>
                <a href="javascript:void(0)" onclick="location.href=SYSTEM_LINKS.portal" class="sidebar-link px-4 py-2.5 rounded-xl flex items-center gap-3 text-sm text-slate-400 hover:text-white mb-1 transition">
                    <i class="ri-apps-2-line"></i> è¨“ç·´ç®¡ç†æ•´åˆå¹³å°
                </a>
                <a href="javascript:void(0)" onclick="location.href=SYSTEM_LINKS.flow" class="sidebar-link px-4 py-2.5 rounded-xl flex items-center gap-3 text-sm text-slate-400 hover:text-white mb-1 transition">
                    <i class="ri-flow-chart"></i> è¨“ç·´æµè·¯ç®¡ç†ç³»çµ±
                </a>
                <a href="javascript:void(0)" onclick="location.href=SYSTEM_LINKS.booking" class="sidebar-link px-4 py-2.5 rounded-xl flex items-center gap-3 text-sm text-slate-400 hover:text-white transition">
                    <i class="ri-building-2-line"></i> å ´åœ°å€Ÿç”¨ç³»çµ±
                </a>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-800 text-center text-xs text-slate-500">TFD Training Â© 2026</div>
    </aside>

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative min-w-0">
        
        <header class="bg-white border-b border-slate-200 h-14 flex items-center justify-between px-4 md:hidden shrink-0 z-10">
            <div class="font-bold text-slate-700 flex items-center gap-2">
                <span class="w-6 h-6 bg-blue-600 rounded flex items-center justify-center text-white"><i class="ri-charging-pile-2-line"></i></span>
                é›»å‹•è»Šè¨“ç·´
            </div>
            <button onclick="toggleSidebar()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                <i class="ri-menu-line text-xl"></i>
            </button>
        </header>

        <!-- âš ï¸ å°šæœªçµæ¡ˆæé†’æ©«å¹… -->
        <div id="alertBanner" class="bg-rose-50 border-b border-rose-200 px-6 py-4 flex items-start gap-3 hidden shadow-sm shrink-0">
            <div class="mt-1 bg-rose-100 p-1.5 rounded-full"><i class="ri-alarm-warning-fill text-rose-500 text-lg"></i></div>
            <div class="flex-1">
                <h3 class="font-bold text-rose-800 text-sm mb-1 flex items-center gap-2">
                    <span id="alertTitle">å°šæœªçµæ¡ˆæé†’</span>
                    <button onclick="loadHistory(true)" class="text-xs bg-white border border-rose-200 px-2 py-0.5 rounded hover:bg-rose-50"><i class="ri-refresh-line"></i> é‡æ•´</button>
                </h3>
                <div class="text-xs text-rose-600 leading-relaxed" id="alertContent">è¼‰å…¥ä¸­...</div>
            </div>
            <button onclick="$('#alertBanner').classList.add('hidden')" class="text-rose-400 hover:text-rose-700"><i class="ri-close-line text-lg"></i></button>
        </div>

        <div id="page-input" class="flex-1 flex flex-col p-6 overflow-y-auto h-full">
            
            <!-- â˜… æœ¬æœˆå¡«å ±ç¢ºèªå€ â˜… -->
            <div class="bg-white border border-slate-200 border-l-4 border-l-yellow-400 rounded-xl p-5 mb-6 shadow-sm shrink-0 relative">
                <div class="flex items-center gap-2 mb-3">
                    <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                        <i class="ri-checkbox-circle-line text-yellow-500 text-lg"></i> æœ¬æœˆå¡«å ±ç¢ºèª 
                    </h3>
                    <span class="text-[10px] text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">è‹¥æœ¬æœˆç„¡è³‡æ–™è«‹é»é¸æ­¤è™•çµæ¡ˆ</span>
                </div>
                
                <div class="flex flex-wrap items-end gap-3">
                    <div class="flex-1 min-w-[140px]">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">é¸æ“‡å¤§éšŠ</label>
                        <select id="selBat" onchange="renderSquadSelect()" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-slate-50 font-bold outline-none focus:border-blue-500"><option value="">å¤§éšŠ...</option></select>
                    </div>
                    <div class="flex-1 min-w-[140px]">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">é¸æ“‡ä¸­éšŠ</label>
                        <select id="selSquad" onchange="renderUnitCheckboxes()" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-slate-50 font-bold outline-none focus:border-blue-500" disabled><option value="">è«‹å…ˆé¸å¤§éšŠ</option></select>
                    </div>
                    <div class="w-[200px]">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">ç‹€æ…‹</label>
                        <div class="flex bg-slate-100 p-1 rounded-lg">
                            <label class="flex-1 text-center cursor-pointer"><input type="radio" name="auditType" value="å·²å¡«å¯«" checked class="hidden peer"><span class="block text-xs py-1.5 rounded peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm peer-checked:font-bold text-slate-500 transition">å·²å¡«å¯«</span></label>
                            <label class="flex-1 text-center cursor-pointer"><input type="radio" name="auditType" value="æœ¬æœˆç„¡æ›´æ–°" class="hidden peer"><span class="block text-xs py-1.5 rounded peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm peer-checked:font-bold text-slate-500 transition">æœ¬æœˆç„¡æ›´æ–°</span></label>
                        </div>
                    </div>
                    <button onclick="submitAudit()" class="bg-slate-800 text-white px-5 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-700 active:scale-95 transition flex items-center gap-2"><i class="ri-send-plane-fill"></i> é€å‡ºç¢ºèª</button>
                </div>

                <div id="unitCheckArea" class="mt-3 pt-3 border-t border-slate-100 hidden">
                    <div class="flex justify-between mb-2">
                        <span class="text-xs text-slate-400 font-bold">å‹¾é¸å–®ä½ (å¯å¤šé¸)ï¼š</span>
                        <button onclick="toggleAllUnits()" class="text-xs text-blue-500 hover:underline">å…¨é¸</button>
                    </div>
                    <div id="unitCheckboxGrid" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-2"></div>
                </div>
            </div>

            <div class="my-6 flex items-center gap-4 opacity-60">
                <div class="h-px bg-slate-300 flex-1 border-t border-dashed border-slate-300"></div>
                <div class="text-slate-400 text-[10px] font-mono tracking-widest uppercase">New Data Entry</div>
                <div class="h-px bg-slate-300 flex-1 border-t border-dashed border-slate-300"></div>
            </div>

            <!-- â˜… æ–°å¢ä½œæ¥­å€ â˜… -->
            <div class="bg-white border border-slate-200 border-l-4 border-l-blue-600 rounded-xl p-5 shadow-sm flex flex-col flex-1">
                <div class="flex justify-between items-center mb-4 shrink-0 flex-wrap gap-2">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                            <i class="ri-edit-box-line text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-800">æ–°å¢ä½œæ¥­å€</h2>
                            <p class="text-xs text-slate-500">è«‹å¡«å¯«ä¸‹æ–¹è¨“ç·´è³‡æ–™</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-white" onclick="downloadTemplate()"><i class="ri-file-download-line"></i> ä¸‹è¼‰ç¯„æœ¬</button>
                        <button class="btn btn-white" onclick="$('#csvInput').click()"><i class="ri-upload-2-line"></i> åŒ¯å…¥ CSV</button>
                        <button class="btn btn-blue shadow-lg shadow-blue-200" onclick="saveToCloud()"><i class="ri-cloud-upload-line"></i> å„²å­˜</button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table id="inputTable">
                        <thead>
                            <tr>
                                <th style="width:50px">åˆª</th><th style="width:50px">åº</th><th style="width:220px">æ—¥æœŸ</th>
                                <th style="width:150px">å–®ä½</th><th style="width:200px">åœ°é»</th><th style="width:200px">é …ç›®</th>
                                <th style="width:80px">å ´æ¬¡</th><th style="width:100px">äººæ•¸</th><th style="width:150px">å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody id="inputBody"></tbody>
                        <tfoot class="example-row"><tr><td></td><td>Ex</td><td>114å¹´1æœˆ1æ—¥</td><td>ä¿¡ç¾©ä¸­éšŠ</td><td>é§åœ°</td><td>è¨“ç·´</td><td>1</td><td>20</td><td></td></tr></tfoot>
                    </table>
                </div>
                <div class="mt-4 flex justify-center shrink-0"><button class="btn btn-white w-full md:w-auto justify-center" onclick="addInputRow()"><i class="ri-add-line"></i> æ–°å¢ä¸€åˆ—</button></div>
            </div>
        </div>
        
        <!-- â˜… æ­·å²è³‡æ–™åº« â˜… -->
        <div id="page-history" class="hidden flex-col p-6 overflow-hidden h-full">
            <div class="flex justify-between items-center mb-4 shrink-0 flex-wrap gap-2">
                <div class="flex items-center gap-2"><span class="w-1 h-6 bg-emerald-600 rounded-full"></span><h2 class="text-xl font-bold text-slate-800">æ­·å²è³‡æ–™åº«</h2></div>
                <div class="flex gap-2">
                    <button class="btn btn-white" onclick="loadHistory(true)"><i class="ri-refresh-line"></i> é‡æ•´</button>
                    <div class="relative group">
                        <button class="btn btn-green">
                            <i class="ri-file-excel-2-line"></i> ä¸‹è¼‰å ±è¡¨
                        </button>
                        <div class="absolute right-0 top-full pt-2 w-56 hidden group-hover:block z-50">
                            <div class="bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden p-1">
                                <div onclick="exportExcel('report')" class="px-4 py-3 hover:bg-emerald-50 rounded-lg cursor-pointer text-sm font-bold text-emerald-700 mb-1 flex items-center transition">
                                    <i class="ri-file-list-3-line mr-2 text-lg"></i>é™³å ±ä¸Šç´šç‰ˆ (ç²¾ç°¡)
                                </div>
                                <div onclick="exportExcel('full')" class="px-4 py-3 hover:bg-slate-50 rounded-lg cursor-pointer text-sm text-slate-600 flex items-center transition">
                                    <i class="ri-database-2-line mr-2 text-lg"></i>å®Œæ•´è³‡æ–™åº« (å‚™ä»½)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-emerald-50 border border-emerald-100 px-4 py-3 rounded-xl mb-4 flex gap-6 text-sm text-emerald-800 font-bold shadow-sm shrink-0">
                <div>ç¸½å ´æ¬¡ï¼š<span id="histTotalSession">0</span></div><div>ç¸½äººæ•¸ï¼š<span id="histTotalPeople">0</span></div>
            </div>
            <div class="table-wrapper flex-1 min-h-0 overflow-auto bg-white border border-slate-200 rounded-lg shadow-sm mb-0">
                <table id="historyTable">
                    <thead><tr><th style="width:60px">é …æ¬¡</th><th style="width:220px">æ—¥æœŸ</th><th style="width:120px">å–®ä½</th><th style="width:150px">åœ°é»</th><th style="width:200px">é …ç›®</th><th style="width:60px">å ´æ¬¡</th><th style="width:60px">äººæ•¸</th><th style="width:120px">å‚™è¨»</th><th style="width:100px">ç…§ç‰‡</th></tr></thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
            <div class="h-[60px] flex items-center justify-between border-t border-slate-200 pt-3 mt-2 shrink-0 bg-slate-100">
                <div class="text-sm text-slate-500">é¡¯ç¤ºç¬¬ <span id="pageInfoStart" class="font-bold">0</span> - <span id="pageInfoEnd" class="font-bold">0</span> ç­†ï¼Œå…± <span id="pageInfoTotal" class="font-bold text-slate-700">0</span> ç­†</div>
                <div class="flex gap-2"><button onclick="changePage(-1)" id="prevBtn" class="px-3 py-1 border rounded bg-white">ä¸Šä¸€é </button><button onclick="changePage(1)" id="nextBtn" class="px-3 py-1 border rounded bg-white">ä¸‹ä¸€é </button></div>
            </div>
        </div>

        <!-- â˜… æˆæœå±•ç¤ºç‰† â˜… -->
        <div id="page-gallery" class="hidden flex-1 flex-col p-6 overflow-hidden h-full bg-slate-50">
            <div class="flex justify-between items-center mb-6 shrink-0 flex-wrap gap-3">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-6 bg-yellow-400 rounded-full"></span>
                    <h2 class="text-xl font-bold text-slate-800">æˆæœå±•ç¤ºç‰†</h2>
                </div>
                <div class="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm flex-1 max-w-md">
                    <div class="pl-3 flex items-center text-slate-400"><i class="ri-search-line"></i></div>
                    <input type="text" id="gallerySearchInput" onkeyup="searchGallery()" placeholder="æœå°‹å–®ä½ã€é …ç›®æˆ–æ—¥æœŸ..." class="w-full border-none outline-none bg-transparent px-2 text-sm font-bold text-slate-700 h-9">
                </div>
            </div>
            <div class="flex-1 overflow-y-auto min-h-0 pr-2 scroll-smooth" id="galleryContainer">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="galleryGrid"></div>
            </div>
            <div class="h-[60px] flex items-center justify-between border-t border-slate-200 pt-3 mt-2 shrink-0">
                <div class="text-sm text-slate-500">é¡¯ç¤ºç¬¬ <span id="galInfoStart" class="font-bold">0</span> - <span id="galInfoEnd" class="font-bold">0</span> ç­†ï¼Œå…± <span id="galInfoTotal" class="font-bold text-slate-700">0</span> ç­†</div>
                <div class="flex gap-2">
                    <button onclick="changeGalleryPage(-1)" id="galPrevBtn" class="px-4 py-2 border border-slate-300 rounded-lg bg-white hover:bg-slate-50 text-sm font-bold">ä¸Šä¸€é </button>
                    <button onclick="changeGalleryPage(1)" id="galNextBtn" class="px-4 py-2 border border-slate-300 rounded-lg bg-white hover:bg-slate-50 text-sm font-bold">ä¸‹ä¸€é </button>
                </div>
            </div>
        </div>
    </main>

    <!-- éš±è—æ§åˆ¶é … -->
    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">
    <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handlePhotoUpload(this)">

    <!-- è¬ç”¨æ—¥æ›† Modal -->
    <div id="calendarModal" class="fixed inset-0 bg-black/50 hidden z-[1000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[350px] p-5 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-2">
                <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-100 rounded"><i class="ri-arrow-left-s-line"></i></button>
                <div class="font-bold text-lg" id="calMonthTitle">2025å¹´ 1æœˆ</div>
                <button onclick="changeMonth(1)" class="p-1 hover:bg-slate-100 rounded"><i class="ri-arrow-right-s-line"></i></button>
            </div>
            <div class="flex gap-2 mb-3 text-xs">
                <button onclick="calFilter('all')" class="flex-1 py-1 border rounded hover:bg-slate-50">å…¨é¸</button>
                <button onclick="calFilter('noWeekend')" class="flex-1 py-1 border rounded hover:bg-slate-50">æ’é™¤å…­æ—¥</button>
                <button onclick="calFilter('onlyWeekend')" class="flex-1 py-1 border rounded hover:bg-slate-50">åƒ…é¸å…­æ—¥</button>
                <button onclick="calClear()" class="px-2 py-1 border text-red-500 rounded hover:bg-red-50">æ¸…</button>
            </div>
            <div class="calendar-grid text-sm font-bold text-slate-400 mb-1"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
            <div id="calGrid" class="calendar-grid"></div>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="$('#calendarModal').classList.add('hidden'); $('#calendarModal').classList.remove('flex');" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="confirmDate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        const $ = (s) => document.querySelector(s);
        let inputData = [], historyData = [], auditLogs={}; 
        let currentCalRow = null, selectedDates = new Set(), currentYear = 2026, currentMonth = 1;
        let currentPage = 1, galleryPage = 1;
        const itemsPerPage = 20, galleryPerPage = 24;
        let uploadTarget = null, gallerySearchText = "";

        window.onload = function() { 
            const now = new Date();
            currentYear = now.getFullYear();
            currentMonth = now.getMonth() + 1;
            addInputRow(); 
            initAuditDropdowns(); 
            loadHistory(true);    
        };

        function toggleSidebar() {
            const sidebar = $('#mainSidebar');
            const overlay = $('#sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full'); 
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full'); 
                overlay.classList.add('hidden');
            }
        }

        function switchPage(page) {
            if(window.innerWidth < 768) toggleSidebar();
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            if($('#nav-'+page)) $('#nav-'+page).classList.add('active');
            ['input', 'history', 'gallery'].forEach(p => {
                const el = $('#page-'+p);
                el.classList.add('hidden');
                el.classList.remove('flex');
            });
            const target = $('#page-'+page);
            target.classList.remove('hidden');
            if(page !== 'input') target.classList.add('flex');
            if(page === 'gallery') renderGallery();
        }

        function fixYearFormat(val) {
            if (!val) return "";
            if (typeof val === 'string') {
                if (val.match(/^0+(1\d{2}å¹´)/)) return val.replace(/^0+(1\d{2}å¹´)/, '$1');
                if (val.includes('å¹´')) return val;
            }
            const d = new Date(val);
            if (!isNaN(d.getTime())) {
                let y = d.getFullYear(); const m = d.getMonth() + 1; const day = d.getDate();
                if (y > 1911) y -= 1911; 
                return `${y}å¹´${m}æœˆ${day}æ—¥`;
            }
            return val;
        }

        function addInputRow(data={}) {
            inputData.push({ date: data.date||'', unit: data.unit||'', loc: data.loc||'', item: data.item||'', session: data.session||'', people: data.people||'', note: data.note||'' });
            renderInputTable();
        }

        function removeInputRow(idx) {
            if (inputData.length > 1) inputData.splice(idx, 1); 
            else inputData[0] = {date:'', unit:'', loc:'', item:'', session:'', people:'', note:''};
            renderInputTable();
        }

        function renderInputTable() {
            const tbody = $('#inputBody'); tbody.innerHTML = '';
            inputData.forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center align-middle"><button onclick="removeInputRow(${i})" class="text-slate-300 hover:text-red-500"><i class="ri-close-circle-fill text-xl"></i></button></td>
                    <td class="text-center text-slate-400 font-mono align-middle">${i + 1}</td>
                    <td><div class="flex items-center h-full relative"><input type="text" value="${row.date}" onchange="inputData[${i}].date=this.value" placeholder="é»æ“Šé¸å–æ—¥æœŸ"><button onclick="openCalendar(${i})" class="absolute right-0 top-0 h-full w-8 text-slate-400 hover:text-blue-600"><i class="ri-calendar-line"></i></button></div></td>
                    <td><input type="text" value="${row.unit}" onchange="inputData[${i}].unit=this.value" placeholder="è«‹å¡«å¯«"></td>
                    <td><input type="text" value="${row.loc}" onchange="inputData[${i}].loc=this.value" placeholder="è«‹å¡«å¯«"></td>
                    <td><input type="text" value="${row.item}" onchange="inputData[${i}].item=this.value" placeholder="è«‹å¡«å¯«"></td>
                    <td><input type="number" value="${row.session}" onchange="inputData[${i}].session=this.value" placeholder="0"></td>
                    <td><input type="number" value="${row.people}" onchange="inputData[${i}].people=this.value" placeholder="0"></td>
                    <td><input type="text" value="${row.note}" onchange="inputData[${i}].note=this.value" placeholder="é¸å¡«"></td>`;
                tbody.appendChild(tr);
            });
        }

        function showLoading(msg) { $('#loadingText').innerText = msg; $('#loading').style.display = 'flex'; }
        function hideLoading() { $('#loading').style.display = 'none'; }

        function saveToCloud() {
            const validData = inputData.filter(r => r.date || r.item || r.unit);
            if (validData.length === 0) return alert('æ²’æœ‰è³‡æ–™å¯å„²å­˜');
            validData.forEach(r => r.date = fixYearFormat(r.date));
            showLoading("è³‡æ–™å„²å­˜ä¸­...");
            fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ data: validData, mode: 'append' }), headers: { 'Content-Type': 'text/plain' } })
            .then(res => res.json())
            .then(json => {
                if (json.status === 'success') { alert('å„²å­˜æˆåŠŸï¼'); inputData=[]; addInputRow(); loadHistory(); } 
                else alert('å„²å­˜å¤±æ•—: ' + json.message);
            }).catch(e => alert('é€£ç·šéŒ¯èª¤')).finally(() => hideLoading());
        }

        function loadHistory(refresh = false) {
            if(GAS_API_URL.includes("è«‹å¡«å…¥")) return;
            if(refresh) showLoading("è³‡æ–™åŒæ­¥ä¸­...");
            fetch(GAS_API_URL).then(r => r.json()).then(json => {
                if (json.status === 'success') {
                    historyData = json.data || [];
                    historyData.forEach(r => r.date = fixYearFormat(r.date));
                    historyData.sort((a, b) => getDateValue(b.date) - getDateValue(a.date));
                    if(json.audit) {
                        auditLogs = {};
                        json.audit.forEach(log => auditLogs[`${log.ym}_${log.unit}`] = log.type);
                    }
                    renderHistoryTable();
                    renderAlertBanner();
                    renderUnitCheckboxes(); 
                    renderGallery();
                }
            }).finally(() => hideLoading());
        }

        // ==========================================
        // â˜… Smart Alert Banner (è‡ªå‹•èˆ‡æ‰‹å‹•é›™é‡æª¢æ ¸)
        // ==========================================
        function renderAlertBanner() {
            const now = new Date();
            const yearAD = now.getFullYear();
            const month = now.getMonth() + 1;
            const yearROC = yearAD - 1911;
            
            const ymKey = `${yearAD}-${String(month).padStart(2,'0')}`;
            const rocLabel = `${yearROC}å¹´${month}æœˆ`;

            // 1. è‡ªå‹•åµæ¸¬æœ¬æœˆå·²æœ‰å¡«å¯«è³‡æ–™çš„å–®ä½
            const unitsWithData = new Set();
            historyData.forEach(row => {
                const m = row.date.match(/(\d+)å¹´(\d+)æœˆ/);
                if (m && parseInt(m[1]) === yearROC && parseInt(m[2]) === month) {
                    unitsWithData.add(row.unit);
                }
            });

            let missing = [], totalCount = 0;
            for (const [bat, squads] of Object.entries(AUDIT_UNITS)) {
                let batMissing = [];
                Object.values(squads).flat().forEach(u => {
                    const hasManual = auditLogs[`${ymKey}_${u}`];
                    const hasData = unitsWithData.has(u);
                    if (!hasManual && !hasData) batMissing.push(u);
                });
                if (batMissing.length > 0) {
                    totalCount += batMissing.length;
                    missing.push(`<strong>${bat}</strong>ï¼š${batMissing.join('ã€')}`);
                }
            }

            const banner = $('#alertBanner');
            if (missing.length > 0) {
                banner.classList.remove('hidden');
                $('#alertTitle').innerText = `âš ï¸ ${rocLabel} å°šæœªçµæ¡ˆæé†’ (å‰©é¤˜ ${totalCount} å€‹å–®ä½)`;
                $('#alertContent').innerHTML = missing.join('<br>');
            } else {
                banner.classList.add('hidden');
            }
        }

        function initAuditDropdowns() {
            const selBat = $('#selBat');
            selBat.innerHTML = '<option value="">è«‹é¸æ“‡å¤§éšŠ...</option>';
            Object.keys(AUDIT_UNITS).forEach(bat => selBat.innerHTML += `<option value="${bat}">${bat}</option>`);
        }

        function renderSquadSelect() {
            const bat = $('#selBat').value;
            const selSquad = $('#selSquad');
            $('#unitCheckArea').classList.add('hidden');
            selSquad.innerHTML = '<option value="">è«‹é¸æ“‡ä¸­éšŠ...</option>';
            selSquad.disabled = true;
            if(bat) {
                selSquad.disabled = false;
                selSquad.innerHTML += '<option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>';
                Object.keys(AUDIT_UNITS[bat]).forEach(sq => selSquad.innerHTML += `<option value="${sq}">${sq}</option>`);
            }
        }

        function renderUnitCheckboxes() {
            const bat = $('#selBat').value, sq = $('#selSquad').value;
            const grid = $('#unitCheckboxGrid'), area = $('#unitCheckArea');
            if(!bat || !sq) return area.classList.add('hidden');
            area.classList.remove('hidden'); grid.innerHTML = '';
            let units = (sq === 'ALL') ? Object.values(AUDIT_UNITS[bat]).flat() : AUDIT_UNITS[bat][sq];
            const ym = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
            units.forEach(u => {
                const isChecked = !!auditLogs[`${ym}_${u}`];
                const div = document.createElement('div');
                if(isChecked) div.innerHTML = `<div class="bg-emerald-50 border border-emerald-200 text-emerald-600 rounded px-2 py-1 text-xs font-bold opacity-60 cursor-not-allowed"><i class="ri-checkbox-circle-fill"></i> ${u} (å·²çµæ¡ˆ)</div>`;
                else div.innerHTML = `<label class="flex items-center gap-2 cursor-pointer border border-slate-200 rounded px-2 py-1 hover:bg-slate-50 transition"><input type="checkbox" name="auditUnit" value="${u}" class="w-4 h-4 text-blue-600 rounded"><span class="text-xs font-bold text-slate-700 select-none">${u}</span></label>`;
                grid.appendChild(div);
            });
        }

        function toggleAllUnits() {
            const cbs = document.querySelectorAll('input[name="auditUnit"]');
            const all = Array.from(cbs).every(c => c.checked);
            cbs.forEach(c => c.checked = !all);
        }

        function submitAudit() {
            const checked = Array.from(document.querySelectorAll('input[name="auditUnit"]:checked')).map(c => c.value);
            if(checked.length === 0) return alert('è«‹å…ˆå‹¾é¸å–®ä½');
            const type = document.querySelector('input[name="auditType"]:checked').value;
            const ym = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
            showLoading("é€å‡ºç¢ºèªä¸­...");
            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify({ mode: 'update_audit', data: checked.map(u => ({ ym, unit: u, type })) }),
                headers: { 'Content-Type': 'text/plain' }
            }).then(r => r.json()).then(json => {
                if(json.status === 'success') {
                    checked.forEach(u => auditLogs[`${ym}_${u}`] = type);
                    renderAlertBanner(); renderUnitCheckboxes(); alert('çµæ¡ˆæˆåŠŸ');
                }
            }).finally(() => hideLoading());
        }

        function renderHistoryTable() {
            const tbody = $('#historyBody'); tbody.innerHTML = '';
            let tS = 0, tP = 0;
            historyData.forEach(r => { tS += parseInt(r.session)||0; tP += parseInt(r.people)||0; });
            $('#histTotalSession').innerText = tS; $('#histTotalPeople').innerText = tP;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = historyData.slice(start, end);

            pageData.forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.className = i % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                const photoBtn = row.folderUrl ? 
                    `<div class="flex gap-2 justify-center"><a href="${row.folderUrl}" target="_blank" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-emerald-700 shadow-sm"><i class="ri-folder-open-fill"></i> å·²å»ºæª”</a><button onclick="triggerPhotoUpload(${start+i})" class="text-slate-300 hover:text-blue-500"><i class="ri-add-circle-fill text-lg"></i></button></div>` :
                    `<button onclick="triggerPhotoUpload(${start+i})" class="text-slate-400 hover:text-blue-600 bg-slate-50 px-3 py-1 rounded border border-slate-200 text-xs flex items-center gap-1 mx-auto"><i class="ri-camera-line"></i> ä¸Šå‚³</button>`;

                tr.innerHTML = `<td class="text-center font-mono text-xs">${start+i+1}</td><td class="px-2">${row.date}</td><td class="px-2">${row.unit}</td><td class="px-2">${row.loc}</td><td class="px-2">${row.item}</td><td class="text-center font-bold text-blue-600">${row.session}</td><td class="text-center font-bold text-emerald-600">${row.people}</td><td class="px-2 text-xs text-slate-400">${row.note}</td><td class="text-center">${photoBtn}</td>`;
                tbody.appendChild(tr);
            });

            $('#pageInfoStart').innerText = historyData.length > 0 ? start + 1 : 0;
            $('#pageInfoEnd').innerText = Math.min(end, historyData.length);
            $('#pageInfoTotal').innerText = historyData.length;
            $('#prevBtn').disabled = currentPage === 1;
            $('#nextBtn').disabled = end >= historyData.length;
        }

        function changePage(delta) { 
            currentPage += delta; 
            renderHistoryTable(); 
        }

        function triggerPhotoUpload(index) { 
            uploadTarget = historyData[index]; 
            $('#photoInput').click(); 
        }

        async function handlePhotoUpload(input) {
            if (!input.files.length || !uploadTarget) return;
            showLoading(`æ­£åœ¨è™•ç† ${input.files.length} å¼µç…§ç‰‡ (å£“ç¸®ä¸­)...`);
            let count = 0;
            for (let file of input.files) {
                try {
                    const base64 = await compressImage(file);
                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ mode: 'upload_image', data: { date: uploadTarget.date, unit: uploadTarget.unit, item: uploadTarget.item, fileData: base64.split(',')[1], mimeType: 'image/jpeg', fileName: file.name.replace(/\.[^/.]+$/, "") + ".jpg" } }),
                        headers: { 'Content-Type': 'text/plain' }
                    });
                    if((await res.json()).status === 'success') count++;
                } catch(e) { console.error(e); }
            }
            hideLoading(); input.value = '';
            if(count > 0) { alert(`æˆåŠŸä¸Šå‚³ ${count} å¼µï¼`); loadHistory(); }
        }

        function compressImage(file, quality = 0.85, maxWidth = 2560) {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
                        const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
            });
        }

        function renderGallery() {
            let filtered = historyData.filter(r => gallerySearchText === "" || `${r.date} ${r.unit} ${r.item}`.toLowerCase().includes(gallerySearchText));
            const maxPage = Math.ceil(filtered.length / galleryPerPage) || 1;
            if (galleryPage > maxPage) galleryPage = maxPage;
            const start = (galleryPage - 1) * galleryPerPage;
            const display = filtered.slice(start, start + galleryPerPage);
            const grid = $('#galleryGrid'); grid.innerHTML = '';
            
            display.forEach(item => {
                const div = document.createElement('div');
                div.className = 'gallery-card bg-white rounded-xl shadow-sm overflow-hidden border border-slate-100 cursor-pointer group hover:shadow-md';
                div.onclick = () => item.folderUrl && window.open(item.folderUrl, '_blank');
                const img = item.coverUrl ? `<img src="${item.coverUrl}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" loading="lazy">` : `<div class="w-full h-full bg-slate-100 flex flex-col items-center justify-center text-slate-400"><i class="ri-folder-unknow-line text-3xl"></i><span class="text-[10px] mt-1">ç„¡ç…§ç‰‡</span></div>`;
                div.innerHTML = `<div class="relative overflow-hidden aspect-video bg-slate-50">${img}${item.folderUrl ? '<div class="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded">ç›¸ç°¿</div>' : ''}</div><div class="p-4"><h3 class="font-bold text-slate-800 line-clamp-1 text-sm mb-1">${item.item}</h3><div class="flex justify-between text-xs text-slate-500"><span>${item.date}</span><span class="bg-slate-100 px-2 rounded">${item.unit}</span></div></div>`;
                grid.appendChild(div);
            });

            $('#galInfoStart').innerText = filtered.length > 0 ? start + 1 : 0;
            $('#galInfoEnd').innerText = Math.min(start + galleryPerPage, filtered.length);
            $('#galInfoTotal').innerText = filtered.length;
            $('#galPrevBtn').disabled = galleryPage === 1;
            $('#galNextBtn').disabled = galleryPage >= maxPage;
        }

        function searchGallery() { gallerySearchText = $('#gallerySearchInput').value.toLowerCase(); galleryPage = 1; renderGallery(); }
        function changeGalleryPage(d) { galleryPage += d; renderGallery(); }

        function getDateValue(s) {
            const m = s.match(/(\d+)å¹´(\d+)æœˆ(\d+)/);
            return m ? parseInt(m[1])*10000 + parseInt(m[2])*100 + parseInt(m[3]) : 0;
        }

        function openCalendar(i) {
            currentCalRow = i; selectedDates.clear();
            $('#calendarModal').classList.remove('hidden'); $('#calendarModal').classList.add('flex');
            renderCalendarGrid();
        }

        function renderCalendarGrid() {
            const grid = $('#calGrid'); grid.innerHTML = '';
            $('#calMonthTitle').innerText = `${currentYear}å¹´ ${currentMonth}æœˆ`;
            const days = new Date(currentYear, currentMonth, 0).getDate();
            const first = new Date(currentYear, currentMonth - 1, 1).getDay();
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="day-cell empty border-none"></div>`;
            for(let d=1; d<=days; d++) {
                const key = `${currentYear}/${currentMonth}/${d}`, w = new Date(currentYear, currentMonth-1, d).getDay();
                const sel = selectedDates.has(key), div = document.createElement('div');
                div.className = `day-cell ${(w===0||w===6)?'weekend':''} ${sel?'selected':''}`; div.innerText = d;
                div.onclick = () => { if(sel) selectedDates.delete(key); else selectedDates.add(key); renderCalendarGrid(); };
                grid.appendChild(div);
            }
        }

        function changeMonth(d) { currentMonth+=d; if(currentMonth>12){currentMonth=1;currentYear++;} if(currentMonth<1){currentMonth=12;currentYear--;} renderCalendarGrid(); }
        function calClear() { selectedDates.clear(); renderCalendarGrid(); }
        function calFilter(t) {
            const days = new Date(currentYear, currentMonth, 0).getDate();
            for(let d=1; d<=days; d++) {
                const key = `${currentYear}/${currentMonth}/${d}`, w = new Date(currentYear, currentMonth-1, d).getDay();
                if(t==='all' || (t==='noWeekend' && w!==0 && w!==6) || (t==='onlyWeekend' && (w===0||w===6))) selectedDates.add(key);
            }
            renderCalendarGrid();
        }

        function confirmDate() {
            const sorted = Array.from(selectedDates).map(s => s.split('/').map(Number)).sort((a,b) => (a[0]*10000+a[1]*100+a[2])-(b[0]*10000+b[1]*100+b[2]));
            if(!sorted.length) return $('#calendarModal').classList.add('hidden');
            let groups = {}; sorted.forEach(d => { const k = `${d[0]}-${d[1]}`; if(!groups[k]) groups[k]=[]; groups[k].push(d[2]); });
            let ps = []; for(let k in groups) { const [y,m] = k.split('-'); ps.push(`${y-1911}å¹´${m}æœˆ${groups[k].join('ã€')}æ—¥`); }
            inputData[currentCalRow].date = ps.join('ï¼›'); renderInputTable(); $('#calendarModal').classList.add('hidden');
        }

        async function exportExcel(mode) {
            const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('çµ±è¨ˆè¡¨');
            const isFull = mode === 'full';
            ws.columns = isFull ? [{header:'é …æ¬¡',key:'id',width:8},{header:'æ—¥æœŸ',key:'date',width:30},{header:'å–®ä½',key:'unit',width:20},{header:'åœ°é»',key:'loc',width:25},{header:'é …ç›®',key:'item',width:40},{header:'å ´æ¬¡',key:'session',width:12},{header:'äººæ•¸',key:'people',width:12},{header:'å‚™è¨»',key:'note',width:20}] : [{header:'é …æ¬¡',key:'id',width:8},{header:'æ—¥æœŸ',key:'date',width:35},{header:'è¨“ç·´é …ç›®',key:'item',width:45},{header:'å ´æ¬¡',key:'session',width:15},{header:'äººæ•¸',key:'people',width:15}];
            ws.getRow(1).eachCell(c => { c.font={bold:true,color:{argb:'FFFFFFFF'}}; c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF1F2937'}}; });
            historyData.forEach((r,i) => ws.addRow({...r, id:i+1}));
            const buf = await wb.xlsx.writeBuffer(); saveAs(new Blob([buf]), 'è¨“ç·´çµ±è¨ˆ.xlsx');
        }

        function downloadTemplate() {
            const csv = "\uFEFFæ—¥æœŸ,å–®ä½,åœ°é»,é …ç›®,å ´æ¬¡,äººæ•¸,å‚™è¨»\n115å¹´1æœˆ1æ—¥,ä¿¡ç¾©ä¸­éšŠ,é§åœ°,æ»…ç«æ¯¯æ“ä½œ,1,15,ç¯„ä¾‹";
            saveAs(new Blob([csv], { type: 'text/csv;charset=utf-8;' }), "è¨“ç·´çµ±è¨ˆç¯„æœ¬.csv");
        }

        function processCSV(input) {
            if (!input.files[0]) return;
            Papa.parse(input.files[0], { header: true, encoding: "Big5", skipEmptyLines: true, complete: function (res) {
                res.data.forEach(r => {
                    const get = (ks) => { for(let k of Object.keys(r)) if(ks.some(key=>k.includes(key))) return r[k]; return ''; };
                    inputData.push({ date: fixYearFormat(get(['æ—¥æœŸ'])), unit: get(['å–®ä½']), loc: get(['åœ°é»']), item: get(['é …ç›®']), session: get(['å ´æ¬¡']), people: get(['äººæ•¸']), note: get(['å‚™è¨»']) });
                });
                renderInputTable(); alert('åŒ¯å…¥å®Œæˆ'); input.value = '';
            }});
        }
    </script>
</body>
</html>
